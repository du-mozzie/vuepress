(window.webpackJsonp=window.webpackJsonp||[]).push([[49],{615:function(a,s,t){"use strict";t.r(s);var e=t(5),r=Object(e.a)({},(function(){var a=this,s=a.$createElement,t=a._self._c||s;return t("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[t("h2",{attrs:{id:"_10-1-集群搭建"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_10-1-集群搭建"}},[a._v("#")]),a._v(" 10.1. 集群搭建")]),a._v(" "),t("h3",{attrs:{id:"_10-1-1-使用集群的原因"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_10-1-1-使用集群的原因"}},[a._v("#")]),a._v(" 10.1.1. 使用集群的原因")]),a._v(" "),t("p",[a._v("​\t\t最开始我们介绍了如何安装及运行 RabbitMQ 服务，不过这些是单机版的，无法满足目前真实应用的要求。如果 RabbitMQ 服务器遇到内存崩溃、机器掉电或者主板故障等情况，该怎么办？单台 RabbitMQ服务器可以满足每秒 1000 条消息的吞吐量，那么如果应用需要 RabbitMQ 服务满足每秒 10 万条消息的吞吐量呢？购买昂贵的服务器来增强单机 RabbitMQ 务的性能显得捉襟见肘，搭建一个 RabbitMQ 集群才是解决实际问题的关键")]),a._v(" "),t("h3",{attrs:{id:"_10-1-2-搭建步骤"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_10-1-2-搭建步骤"}},[a._v("#")]),a._v(" 10.1.2. 搭建步骤")]),a._v(" "),t("ol",[t("li",[t("p",[a._v("修改 3 台机器的主机名称")]),a._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("vim")]),a._v(" /etc/hostname\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br")])])]),a._v(" "),t("li",[t("p",[a._v("配置各个节点的 hosts 文件，让各个节点都能互相识别对方")]),a._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("vim")]),a._v(" /etc/hosts\n"),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("10.211")]),a._v(".55.74 node1\n"),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("10.211")]),a._v(".55.75 node2\n"),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("10.211")]),a._v(".55.76 node3\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br")])]),t("p",[t("img",{attrs:{src:"https://www.itdu.tech/image/image-20220227171608873.png",alt:"image-20220227171608873"}})])]),a._v(" "),t("li",[t("p",[a._v(".以确保各个节点的 cookie 文件使用的是同一个值")]),a._v(" "),t("p",[a._v("在 node1 上执行远程操作命令")]),a._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("scp")]),a._v(" /var/lib/rabbitmq/.erlang.cookie root@node2:/var/lib/rabbitmq/.erlang.cookie\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("scp")]),a._v(" /var/lib/rabbitmq/.erlang.cookie root@node3:/var/lib/rabbitmq/.erlang.cookie\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br")])])]),a._v(" "),t("li",[t("p",[a._v(".启动 RabbitMQ 服务,顺带启动 Erlang 虚拟机和 RbbitMQ 应用服务(在三台节点上分别执行以 下命令)")]),a._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[a._v("rabbitmq-server -detached\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br")])])]),a._v(" "),t("li",[t("p",[a._v("在节点 2 执行")]),a._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[a._v("rabbitmqctl stop_app\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#(rabbitmqctl stop 会将 Erlang 虚拟机关闭， rabbitmqctl stop_app 只关闭 RabbitMQ 服务)")]),a._v("\nrabbitmqctl reset\nrabbitmqctl join_cluster rabbit@node1\nrabbitmqctl start_app"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("只启动应用服务"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br")])])]),a._v(" "),t("li",[t("p",[a._v("在节点 3 执行")]),a._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[a._v("rabbitmqctl stop_app\nrabbitmqctl reset\nrabbitmqctl join_cluster rabbit@node2\nrabbitmqctl start_app\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br")])])]),a._v(" "),t("li",[t("p",[a._v("集群状态")]),a._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[a._v("rabbitmqctl cluster_status\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br")])])]),a._v(" "),t("li",[t("p",[a._v("需要重新设置用户")]),a._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 创建账号")]),a._v("\nrabbitmqctl add_user admin "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("123")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 设置用户角色")]),a._v("\nrabbitmqctl set_user_tags admin administrator\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 设置用户权限")]),a._v("\nrabbitmqctl set_permissions -p "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"/"')]),a._v(" admin "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('".*"')]),a._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('".*"')]),a._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('".*"')]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br"),t("span",{staticClass:"line-number"},[a._v("6")]),t("br")])])]),a._v(" "),t("li",[t("p",[a._v("解除集群节点(node2 和 node3 机器分别执行)")]),a._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[a._v("rabbitmqctl stop_app\nrabbitmqctl reset\nrabbitmqctl start_app\nrabbitmqctl cluster_status\nrabbitmqctl forget_cluster_node rabbit@node2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("node1 机器上执行"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br")])])])]),a._v(" "),t("h2",{attrs:{id:"_10-2-镜像队列"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_10-2-镜像队列"}},[a._v("#")]),a._v(" 10.2. 镜像队列")]),a._v(" "),t("h3",{attrs:{id:"_10-2-1-使用镜像的原因"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_10-2-1-使用镜像的原因"}},[a._v("#")]),a._v(" 10.2.1. 使用镜像的原因")]),a._v(" "),t("p",[a._v("​\t\t如果 RabbitMQ 集群中只有一个 Broker 节点，那么该节点的失效将导致整体服务的临时性不可用，并且也可能会导致消息的丢失。可以将所有消息都设置为持久化，并且对应队列的durable属性也设置为true，但是这样仍然无法避免由于缓存导致的问题：因为消息在发送之后和被写入磁盘井执行刷盘动作之间存在一个短暂却会产生问题的时间窗。通过 publisherconfirm 机制能够确保客户端知道哪些消息己经存入磁盘，尽管如此，一般不希望遇到因单点故障导致的服务不可用。")]),a._v(" "),t("p",[a._v("​\t\t引入镜像队列(Mirror Queue)的机制，可以将队列镜像到集群中的其他 Broker 节点之上，如果集群中的一个节点失效了，队列能自动地切换到镜像中的另一个节点上以保证服务的可用性。")]),a._v(" "),t("h3",{attrs:{id:"_10-2-2-搭建步骤"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_10-2-2-搭建步骤"}},[a._v("#")]),a._v(" 10.2.2. 搭建步骤")]),a._v(" "),t("ol",[t("li",[t("p",[a._v("启动三台集群节点")])]),a._v(" "),t("li",[t("p",[a._v("随便找一个节点添加 policy")]),a._v(" "),t("p",[t("img",{attrs:{src:"https://www.itdu.tech/image/image-20220227175237916.png",alt:"image-20220227175237916"}})])]),a._v(" "),t("li",[t("p",[a._v("在 node1 上创建一个队列发送一条消息，队列存在镜像队列")]),a._v(" "),t("p",[t("img",{attrs:{src:"https://www.itdu.tech/image/image-20220227175257411.png",alt:"image-20220227175257411"}})])]),a._v(" "),t("li",[t("p",[a._v("停掉 node1 之后发现 node2 成为镜像队列")]),a._v(" "),t("p",[t("img",{attrs:{src:"https://www.itdu.tech/image/image-20220227175323583.png",alt:"image-20220227175323583"}})])]),a._v(" "),t("li",[t("p",[a._v("就算整个集群只剩下一台机器了 依然能消费队列里面的消息")]),a._v(" "),t("p",[a._v("说明队列里面的消息被镜像队列传递到相应机器里面了")])])]),a._v(" "),t("h2",{attrs:{id:"_10-3-haproxy-keepalive-实现高可用负载均衡"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_10-3-haproxy-keepalive-实现高可用负载均衡"}},[a._v("#")]),a._v(" 10.3. Haproxy+Keepalive 实现高可用负载均衡")]),a._v(" "),t("h3",{attrs:{id:"_10-3-1-整体架构图"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_10-3-1-整体架构图"}},[a._v("#")]),a._v(" 10.3.1. 整体架构图")]),a._v(" "),t("p",[t("img",{attrs:{src:"https://www.itdu.tech/image/image-20220227175427065.png",alt:"image-20220227175427065"}})]),a._v(" "),t("h3",{attrs:{id:"_10-3-2-haproxy-实现负载均衡"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_10-3-2-haproxy-实现负载均衡"}},[a._v("#")]),a._v(" 10.3.2. Haproxy 实现负载均衡")]),a._v(" "),t("p",[a._v("​\t\tHAProxy 提供高可用性、负载均衡及基于 TCPHTTP 应用的代理，支持虚拟主机，它是免费、快速并且可靠的一种解决方案，包括Twitter,Reddit,StackOverflow,GitHub 在内的多家知名互联网公司在使用。HAProxy 实现了一种事件驱动、单一进程模型，此模型支持非常大的井发连接数。")]),a._v(" "),t("p",[a._v("​\t\t扩展 nginx,lvs,haproxy 之间的区别: http://www.ha97.com/5646.html")]),a._v(" "),t("h3",{attrs:{id:"_10-3-3-搭建步骤"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_10-3-3-搭建步骤"}},[a._v("#")]),a._v(" 10.3.3. 搭建步骤")]),a._v(" "),t("ol",[t("li",[t("p",[a._v("下载 haproxy(在 node1 和 node2)")]),a._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[a._v("yum -y "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("install")]),a._v(" haproxy\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br")])])]),a._v(" "),t("li",[t("p",[a._v("修改 node1 和 node2 的 haproxy.cfg")]),a._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("vim")]),a._v(" /etc/haproxy/haproxy.cfg\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br")])]),t("p",[a._v("需要修改红色 IP 为当前机器 IP")]),a._v(" "),t("p",[t("img",{attrs:{src:"https://www.itdu.tech/image/image-20220227175626908.png",alt:"image-20220227175626908"}})])]),a._v(" "),t("li",[t("p",[a._v("在两台节点启动 haproxy")]),a._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[a._v("haproxy -f /etc/haproxy/haproxy.cfg\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("ps")]),a._v(" -ef "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("grep")]),a._v(" haproxy\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br")])])]),a._v(" "),t("li",[t("p",[a._v("访问地址")]),a._v(" "),t("p",[a._v("http://10.211.55.71:8888/stats")])])]),a._v(" "),t("h3",{attrs:{id:"_10-3-4-keepalived-实现双机-主备-热备"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_10-3-4-keepalived-实现双机-主备-热备"}},[a._v("#")]),a._v(" 10.3.4. Keepalived 实现双机(主备)热备")]),a._v(" "),t("p",[a._v("​\t\t试想如果前面配置的 HAProxy 主机突然宕机或者网卡失效，那么虽然 RbbitMQ 集群没有任何故障但是对于外界的客户端来说所有的连接都会被断开结果将是灾难性的为了确保负载均衡服务的可靠性同样显得十分重要，这里就要引入 Keepalived 它能够通过自身健康检查、资源接管功能做高可用(双机热备)，实现故障转移。")]),a._v(" "),t("h3",{attrs:{id:"_10-3-5-搭建步骤"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_10-3-5-搭建步骤"}},[a._v("#")]),a._v(" 10.3.5. 搭建步骤")]),a._v(" "),t("ol",[t("li",[t("p",[a._v("下载 keepalived")]),a._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[a._v("yum -y "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("install")]),a._v(" keepalived\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br")])])]),a._v(" "),t("li",[t("p",[a._v("节点 node1 配置文件")]),a._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("vim")]),a._v(" /etc/keepalived/keepalived.conf\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br")])])]),a._v(" "),t("li",[t("p",[a._v("节点 node2 配置文件")]),a._v(" "),t("p",[a._v("需要修改 global_defs 的 router_id,如:nodeB")]),a._v(" "),t("p",[a._v('其次要修改 vrrp_instance_VI 中 state 为"BACKUP"；')]),a._v(" "),t("p",[a._v("最后要将 priority 设置为小于 100 的值")])]),a._v(" "),t("li",[t("p",[a._v("添加 haproxy_chk.sh")]),a._v(" "),t("p",[a._v("(为了防止 HAProxy 服务挂掉之后 Keepalived 还在正常工作而没有切换到 Backup 上，所以这里需要编写一个脚本来检测 HAProxy 务的状态,当 HAProxy 服务挂掉之后该脚本会自动重启 HAProxy 的服务，如果不成功则关闭 Keepalived 服务，这样便可以切换到 Backup 继续工作)")]),a._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("vim")]),a._v(" /etc/keepalived/haproxy_chk.sh\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 修改权限")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("chmod")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("777")]),a._v(" /etc/keepalived/haproxy_chk.sh\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br")])])]),a._v(" "),t("li",[t("p",[a._v("启动 keepalive 命令(node1 和 node2 启动)")]),a._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[a._v("systemctl start keepalived\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br")])])]),a._v(" "),t("li",[t("p",[a._v("观察 Keepalived 的日志")]),a._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("tail")]),a._v(" -f /var/log/messages -n "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("200")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br")])])]),a._v(" "),t("li",[t("p",[a._v("观察最新添加的ip")]),a._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("ip")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("add")]),a._v(" show\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br")])])]),a._v(" "),t("li",[t("p",[a._v("node1 模拟 keepalived 关闭状态")]),a._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[a._v("systemctl stop keepalived\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br")])])]),a._v(" "),t("li",[t("p",[a._v("使用 ip 地址来访问 rabbitmq 集群")])])]),a._v(" "),t("h2",{attrs:{id:"_10-4-federation-exchange"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_10-4-federation-exchange"}},[a._v("#")]),a._v(" 10.4. Federation Exchange")]),a._v(" "),t("h3",{attrs:{id:"_10-4-1-使用它的原因"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_10-4-1-使用它的原因"}},[a._v("#")]),a._v(" 10.4.1. 使用它的原因")]),a._v(" "),t("p",[a._v("​\t\t(broker 北京)， (broker 深圳)彼此之间相距甚远，网络延迟是一个不得不面对的问题。有一个在北京的业务(Client 北京) 需要连接(broker 北京)，向其中的交换器 exchangeA 发送消息，此时的网络延迟很小，(Client 北京)可以迅速将消息发送至 exchangeA 中，就算在开启了 publisherconfirm 机制或者事务机制的情况下，也可以迅速收到确认信息。此时又有个在深圳的业务(Client 深圳)需要向 exchangeA 发送消息，那么(Client 深圳) (broker 北京)之间有很大的网络延迟， (Client 深圳) 将发送消息至 exchangeA 会经历一定的延迟，尤其是在开启了 publisherconfirm 机制或者事务机制的情况下， (Client 深圳) 会等待很长的延迟时间来接收(broker 北京)的确认信息，进而必然造成这条发送线程的性能降低，甚至造成一定程度上的阻塞。")]),a._v(" "),t("p",[a._v("​\t\t将业务(Client 深圳)部署到北京的机房可以解决这个问题，但是如果(Client 深圳)调用的另些服务都部署在深圳，那么又会引发新的时延问题，总不见得将所有业务全部部署在一个机房，那么容灾又何以实现？这里使用 Federation 插件就可以很好地解决这个问题。")]),a._v(" "),t("p",[t("img",{attrs:{src:"https://www.itdu.tech/image/image-20220227180626836.png",alt:"image-20220227180626836"}})]),a._v(" "),t("h3",{attrs:{id:"_10-4-2-搭建步骤"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_10-4-2-搭建步骤"}},[a._v("#")]),a._v(" 10.4.2. 搭建步骤")]),a._v(" "),t("ol",[t("li",[t("p",[a._v("需要保证每台节点单独运行")])]),a._v(" "),t("li",[t("p",[a._v("在每台机器上开启 federation 相关插件")]),a._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[a._v("rabbitmq-plugins "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("enable")]),a._v(" rabbitmq_federation\nrabbitmq-plugins "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("enable")]),a._v(" rabbitmq_federation_management\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br")])]),t("p",[t("img",{attrs:{src:"https://www.itdu.tech/image/image-20220227180712615.png",alt:"image-20220227180712615"}})])]),a._v(" "),t("li",[t("p",[a._v("原理图(先运行 consumer 在 node2 创建 fed_exchange)")]),a._v(" "),t("p",[t("img",{attrs:{src:"https://www.itdu.tech/image/image-20220227180730583.png",alt:"image-20220227180730583"}})])]),a._v(" "),t("li",[t("p",[a._v("在 downstream(node2)配置 upstream(node1)")]),a._v(" "),t("p",[t("img",{attrs:{src:"https://www.itdu.tech/image/image-20220227180744648.png",alt:"image-20220227180744648"}})])]),a._v(" "),t("li",[t("p",[a._v("添加 policy")]),a._v(" "),t("p",[t("img",{attrs:{src:"https://www.itdu.tech/image/image-20220227180755427.png",alt:"image-20220227180755427"}})])]),a._v(" "),t("li",[t("p",[a._v("配置成功")]),a._v(" "),t("p",[t("img",{attrs:{src:"https://www.itdu.tech/image/image-20220227180811578.png",alt:"image-20220227180811578"}})])])]),a._v(" "),t("h2",{attrs:{id:"_10-5-federation-queue"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_10-5-federation-queue"}},[a._v("#")]),a._v(" 10.5. Federation Queue")]),a._v(" "),t("h3",{attrs:{id:"_10-5-1-使用它的原因"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_10-5-1-使用它的原因"}},[a._v("#")]),a._v(" 10.5.1. 使用它的原因")]),a._v(" "),t("p",[a._v("​\t\t联邦队列可以在多个 Broker 节点(或者集群)之间为单个队列提供均衡负载的功能。一个联邦队列可以连接一个或者多个上游队列(upstream queue)，并从这些上游队列中获取消息以满足本地消费者消费消息的需求。")]),a._v(" "),t("h3",{attrs:{id:"_10-5-2-搭建步骤"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_10-5-2-搭建步骤"}},[a._v("#")]),a._v(" 10.5.2. 搭建步骤")]),a._v(" "),t("ol",[t("li",[t("p",[a._v("原理图")]),a._v(" "),t("p",[t("img",{attrs:{src:"https://www.itdu.tech/image/image-20220227180925145.png",alt:"image-20220227180925145"}})])]),a._v(" "),t("li",[t("p",[a._v("添加 upstream(同上)")])]),a._v(" "),t("li",[t("p",[a._v("添加 policy")]),a._v(" "),t("p",[t("img",{attrs:{src:"https://www.itdu.tech/image/image-20220227180943139.png",alt:"image-20220227180943139"}})])])]),a._v(" "),t("h2",{attrs:{id:"_10-6-shovel"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_10-6-shovel"}},[a._v("#")]),a._v(" 10.6. Shovel")]),a._v(" "),t("h3",{attrs:{id:"_10-6-1-使用它的原因"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_10-6-1-使用它的原因"}},[a._v("#")]),a._v(" 10.6.1. 使用它的原因")]),a._v(" "),t("p",[a._v('​\t\tFederation 具备的数据转发功能类似， Shovel 够可靠、持续地从一个 Broker 中的队列(作为源端，即source)拉取数据并转发至另一个 Broker 中的交换器(作为目的端，即 destination)。作为源端的队列和作为目的端的交换器可以同时位于同一个 Broker，也可以位于不同的 Broker 上。 Shovel 可以翻译为"铲子"，是一种比较形象的比喻，这个"铲子"可以将消息从一方"铲子"另一方。 Shovel 行为就像优秀的客户端应用程序能够负责连接源和目的地、负责消息的读写及负责连接失败问题的处理。')]),a._v(" "),t("h3",{attrs:{id:"_10-6-2-搭建步骤"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_10-6-2-搭建步骤"}},[a._v("#")]),a._v(" 10.6.2. 搭建步骤")]),a._v(" "),t("ol",[t("li",[t("p",[a._v("开启插件(需要的机器都开启)")]),a._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[a._v("rabbitmq-plugins "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("enable")]),a._v(" rabbitmq_shovel\nrabbitmq-plugins "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("enable")]),a._v(" rabbitmq_shovel_management\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br")])]),t("p",[t("img",{attrs:{src:"https://www.itdu.tech/image/image-20220227181109640.png",alt:"image-20220227181109640"}})])]),a._v(" "),t("li",[t("p",[a._v("原理图(在源头发送的消息直接回进入到目的地队列)")]),a._v(" "),t("p",[t("img",{attrs:{src:"https://www.itdu.tech/image/image-20220227181121369.png",alt:"image-20220227181121369"}})])]),a._v(" "),t("li",[t("p",[a._v("添加 shovel 源和目的地")]),a._v(" "),t("p",[t("img",{attrs:{src:"https://www.itdu.tech/image/image-20220227181134009.png",alt:"image-20220227181134009"}})])])])])}),[],!1,null,null,null);s.default=r.exports}}]);